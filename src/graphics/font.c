#include "font.h"
#ifdef ROGUE_HAVE_SDL
#include <SDL.h>
extern SDL_Renderer* g_internal_sdl_renderer_ref;
#endif
#include <string.h>

const RogueBitmapFont g_rogue_builtin_font = {5, 7};

/* 5x7 font for characters 32..90 (basic uppercase & punctuation) packed row-wise */
static const unsigned char FONT_BITMAP[] = {
    /* Each glyph: 7 rows of 5 bits -> stored as one byte per row (lowest 5 bits) */
    /* Space (32) */ 0, 0,    0,    0,    0,    0,    0,
    /* ! */ 0x04,       0x04, 0x04, 0x04, 0x00, 0x00, 0x04,
    /* " */ 0x0A,       0x0A, 0x04, 0,    0,    0,    0,
    /* # */ 0x0A,       0x1F, 0x0A, 0x0A, 0x1F, 0x0A, 0x0A,
    /* $ */ 0x04,       0x0F, 0x14, 0x0E, 0x05, 0x1E, 0x04,
    /* % */ 0x18,       0x19, 0x02, 0x04, 0x08, 0x13, 0x03,
    /* & */ 0x0C,       0x12, 0x14, 0x08, 0x15, 0x12, 0x0D,
    /* ' */ 0x06,       0x04, 0x08, 0,    0,    0,    0,
    /* ( */ 0x02,       0x04, 0x08, 0x08, 0x08, 0x04, 0x02,
    /* ) */ 0x08,       0x04, 0x02, 0x02, 0x02, 0x04, 0x08,
    /* * */ 0,          0x04, 0x15, 0x0E, 0x15, 0x04, 0,
    /* + */ 0,          0x04, 0x04, 0x1F, 0x04, 0x04, 0,
    /* , */ 0,          0,    0,    0,    0x06, 0x04, 0x08,
    /* - */ 0,          0,    0,    0x1F, 0,    0,    0,
    /* . */ 0,          0,    0,    0,    0,    0x06, 0x06,
    /* / */ 0x01,       0x02, 0x04, 0x08, 0x10, 0,    0,
    /* 0 */ 0x0E,       0x11, 0x13, 0x15, 0x19, 0x11, 0x0E,
    /* 1 */ 0x04,       0x0C, 0x04, 0x04, 0x04, 0x04, 0x0E,
    /* 2 */ 0x0E,       0x11, 0x01, 0x06, 0x08, 0x10, 0x1F,
    /* 3 */ 0x1F,       0x02, 0x04, 0x02, 0x01, 0x11, 0x0E,
    /* 4 */ 0x02,       0x06, 0x0A, 0x12, 0x1F, 0x02, 0x02,
    /* 5 */ 0x1F,       0x10, 0x1E, 0x01, 0x01, 0x11, 0x0E,
    /* 6 */ 0x06,       0x08, 0x10, 0x1E, 0x11, 0x11, 0x0E,
    /* 7 */ 0x1F,       0x01, 0x02, 0x04, 0x08, 0x08, 0x08,
    /* 8 */ 0x0E,       0x11, 0x11, 0x0E, 0x11, 0x11, 0x0E,
    /* 9 */ 0x0E,       0x11, 0x11, 0x0F, 0x01, 0x02, 0x0C,
    /* : */ 0,          0x06, 0x06, 0,    0x06, 0x06, 0,
    /* ; */ 0,          0x06, 0x06, 0,    0x06, 0x04, 0x08,
    /* < */ 0x02,       0x04, 0x08, 0x10, 0x08, 0x04, 0x02,
    /* = */ 0,          0,    0x1F, 0,    0x1F, 0,    0,
    /* > */ 0x08,       0x04, 0x02, 0x01, 0x02, 0x04, 0x08,
    /* ? */ 0x0E,       0x11, 0x01, 0x06, 0x04, 0,    0x04,
    /* @ */ 0x0E,       0x11, 0x17, 0x15, 0x17, 0x10, 0x0E,
    /* A */ 0x0E,       0x11, 0x11, 0x1F, 0x11, 0x11, 0x11,
    /* B */ 0x1E,       0x11, 0x11, 0x1E, 0x11, 0x11, 0x1E,
    /* C */ 0x0E,       0x11, 0x10, 0x10, 0x10, 0x11, 0x0E,
    /* D */ 0x1C,       0x12, 0x11, 0x11, 0x11, 0x12, 0x1C,
    /* E */ 0x1F,       0x10, 0x10, 0x1E, 0x10, 0x10, 0x1F,
    /* F */ 0x1F,       0x10, 0x10, 0x1E, 0x10, 0x10, 0x10,
    /* G */ 0x0E,       0x11, 0x10, 0x17, 0x11, 0x11, 0x0E,
    /* H */ 0x11,       0x11, 0x11, 0x1F, 0x11, 0x11, 0x11,
    /* I */ 0x0E,       0x04, 0x04, 0x04, 0x04, 0x04, 0x0E,
    /* J */ 0x07,       0x02, 0x02, 0x02, 0x02, 0x12, 0x0C,
    /* K */ 0x11,       0x12, 0x14, 0x18, 0x14, 0x12, 0x11,
    /* L */ 0x10,       0x10, 0x10, 0x10, 0x10, 0x10, 0x1F,
    /* M */ 0x11,       0x1B, 0x15, 0x15, 0x11, 0x11, 0x11,
    /* N */ 0x11,       0x19, 0x15, 0x13, 0x11, 0x11, 0x11,
    /* O */ 0x0E,       0x11, 0x11, 0x11, 0x11, 0x11, 0x0E,
    /* P */ 0x1E,       0x11, 0x11, 0x1E, 0x10, 0x10, 0x10,
    /* Q */ 0x0E,       0x11, 0x11, 0x11, 0x15, 0x12, 0x0D,
    /* R */ 0x1E,       0x11, 0x11, 0x1E, 0x14, 0x12, 0x11,
    /* S */ 0x0F,       0x10, 0x10, 0x0E, 0x01, 0x01, 0x1E,
    /* T */ 0x1F,       0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
    /* U */ 0x11,       0x11, 0x11, 0x11, 0x11, 0x11, 0x0E,
    /* V */ 0x11,       0x11, 0x11, 0x11, 0x11, 0x0A, 0x04,
    /* W */ 0x11,       0x11, 0x11, 0x15, 0x15, 0x15, 0x0A,
    /* X */ 0x11,       0x11, 0x0A, 0x04, 0x0A, 0x11, 0x11,
    /* Y */ 0x11,       0x11, 0x11, 0x0A, 0x04, 0x04, 0x04,
    /* Z */ 0x1F,       0x01, 0x02, 0x04, 0x08, 0x10, 0x1F,
};

static const int FIRST_CHAR = 32;
static const int LAST_CHAR = 90;

void rogue_font_draw_text(int x, int y, const char* text, int scale, RogueColor color)
{
#ifdef ROGUE_HAVE_SDL
    if (!g_internal_sdl_renderer_ref || !text)
        return;
    if (scale < 1)
        scale = 1;
    int gw = g_rogue_builtin_font.glyph_w;
    int gh = g_rogue_builtin_font.glyph_h;
    int penx = x;
    for (const char* p = text; *p; ++p)
    {
        if (*p == '\n')
        {
            penx = x;
            y += gh * scale + 1;
            continue;
        }
        int c = (unsigned char) *p;
        /* Map lowercase ASCII to uppercase since bitmap only has 32..90 */
        if (c >= 'a' && c <= 'z')
            c = c - 'a' + 'A';
        if (c < FIRST_CHAR || c > LAST_CHAR)
        {
            penx += gw * scale + scale;
            continue;
        }
        int idx = (c - FIRST_CHAR) * gh;
        for (int row = 0; row < gh; ++row)
        {
            unsigned char bits = FONT_BITMAP[idx + row];
            for (int col = 0; col < gw; ++col)
            {
                if (bits & (1 << (gw - 1 - col)))
                {
                    SDL_Rect r = {penx + col * scale, y + row * scale, scale, scale};
                    SDL_SetRenderDrawColor(g_internal_sdl_renderer_ref, color.r, color.g, color.b,
                                           color.a);
                    SDL_RenderFillRect(g_internal_sdl_renderer_ref, &r);
                }
            }
        }
        penx += gw * scale + scale; /* spacing */
    }
#else
    (void) x;
    (void) y;
    (void) text;
    (void) scale;
    (void) color;
#endif
}
